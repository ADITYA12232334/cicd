name: ZAP Security Scan (Main Branch)

# Trigger on push to main branch
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read
  actions: write

jobs:
  security-scan:
    name: Run ZAP Security Scan
    runs-on: ubuntu-latest
    
    steps:
      # ========================================================================
      # STEP 1: Checkout Code
      # ========================================================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================================================
      # STEP 2: Set up Python
      # ========================================================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # ========================================================================
      # STEP 3: Install Dependencies
      # ========================================================================
      - name: Install dependencies
        run: |
          pip install python-owasp-zap-v2.4 requests python-dotenv colorama

      # ========================================================================
      # STEP 4: Start ZAP Container
      # ========================================================================
      - name: Start ZAP
        run: |
          docker run -d \
            -p 8080:8080 \
            -v $(pwd):/zap/wrk/:rw \
            --name zap \
            zaproxy/zap-bare \
            zap.sh -daemon \
            -host 0.0.0.0 \
            -port 8080 \
            -config api.disablekey=true \
            -config 'api.addrs.addr.name=.*' \
            -config api.addrs.addr.regex=true

      # ========================================================================
      # STEP 5: Wait for ZAP to be Ready
      # ========================================================================
      - name: Wait for ZAP
        run: |
          echo "Waiting for ZAP to start..."
          timeout 120 bash -c 'until curl -f http://localhost:8080/JSON/core/view/version/; do sleep 2; done'
          echo "ZAP is ready!"

      # ========================================================================
      # STEP 6: Run Security Scan (Standard)
      # ========================================================================
      - name: Run security scan
        env:
          ZAP_TARGET_URL: ${{ secrets.ZAP_TARGET_URL || 'http://testphp.vulnweb.com' }}
          ZAP_SCAN_TYPE: standard
          ZAP_MAX_HIGH: 0
          ZAP_MAX_MEDIUM: 5
          ZAP_MAX_LOW: 999
          ZAP_HOST: localhost
          ZAP_PORT: 8080
          ZAP_REPORT_DIR: ./reports
        run: |
          echo "Starting ZAP security scan..."
          echo "Target: $ZAP_TARGET_URL"
          echo "Scan Type: $ZAP_SCAN_TYPE"
          python step2_configurable_scan.py

      # ========================================================================
      # STEP 7: Upload Reports as Artifacts
      # ========================================================================
      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-reports-main-${{ github.run_number }}
          path: reports/
          retention-days: 90  # Keep main branch reports longer

      # ========================================================================
      # STEP 8: Create Job Summary
      # ========================================================================
      - name: Create job summary
        if: always()
        run: |
          # Get the latest summary file
          SUMMARY_FILE=$(ls -t reports/zap_summary_*.json | head -1)
          
          if [ -f "$SUMMARY_FILE" ]; then
            python3 << 'EOF'
          import json
          import os
          
          with open(os.environ['SUMMARY_FILE']) as f:
              data = json.load(f)
          
          high = data['risk_counts']['High']
          medium = data['risk_counts']['Medium']
          low = data['risk_counts']['Low']
          total = data['total_alerts']
          passed = data['passed']
          
          # Create GitHub Job Summary
          summary = f"""# üîí ZAP Security Scan Results
          
          **Status:** {'‚úÖ PASSED' if passed else '‚ùå FAILED'}
          **Target:** `{data['target_url']}`
          **Scan Type:** {data['scan_type']}
          
          ## Summary
          | Risk Level | Count | Threshold | Status |
          |------------|-------|-----------|--------|
          | üî¥ High | {high} | {data['thresholds']['max_high']} | {'‚úÖ Pass' if high <= data['thresholds']['max_high'] else '‚ùå Fail'} |
          | üü† Medium | {medium} | {data['thresholds']['max_medium']} | {'‚úÖ Pass' if medium <= data['thresholds']['max_medium'] else '‚ùå Fail'} |
          | üü° Low | {low} | {data['thresholds']['max_low']} | {'‚úÖ Pass' if low <= data['thresholds']['max_low'] else '‚ùå Fail'} |
          | **Total** | **{total}** | - | - |
          """
          
          if data.get('high_risk_alerts'):
              summary += "\n## ‚ö†Ô∏è High Risk Vulnerabilities\n\n"
              for i, alert in enumerate(data['high_risk_alerts'][:5], 1):
                  summary += f"{i}. **{alert['name']}**\n"
                  summary += f"   - URL: `{alert['url']}`\n\n"
              
              if len(data['high_risk_alerts']) > 5:
                  summary += f"_...and {len(data['high_risk_alerts']) - 5} more_\n"
          
          summary += "\n---\n"
          summary += "üìä Full reports available in workflow artifacts\n"
          
          # Write to GitHub Step Summary
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'w') as f:
              f.write(summary)
          EOF
          fi
        env:
          SUMMARY_FILE: ${{ env.SUMMARY_FILE }}

      # ========================================================================
      # STEP 9: Fail if Vulnerabilities Exceed Threshold
      # ========================================================================
      - name: Check scan result
        if: always()
        run: |
          SUMMARY_FILE=$(ls -t reports/zap_summary_*.json | head -1)
          
          if [ -f "$SUMMARY_FILE" ]; then
            PASSED=$(python3 -c "import json; print(json.load(open('$SUMMARY_FILE'))['passed'])")
            
            if [ "$PASSED" = "False" ]; then
              echo "‚ùå Security scan failed - vulnerabilities exceed thresholds"
              exit 1
            else
              echo "‚úÖ Security scan passed"
            fi
          else
            echo "‚ùå No summary file found"
            exit 1
          fi

      # ========================================================================
      # STEP 10: Clean Up
      # ========================================================================
      - name: Stop ZAP
        if: always()
        run: |
          docker stop zap || true
          docker rm zap || true