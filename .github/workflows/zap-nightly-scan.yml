name: ZAP Security Scan (Nightly)

# Run every night at 2 AM UTC
on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:  # Allow manual triggers
    inputs:
      target_url:
        description: 'Override target URL'
        required: false
        type: string
      scan_type:
        description: 'Scan type'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - standard
          - full

permissions:
  contents: read
  actions: write
  issues: write  # For creating issues on failures

jobs:
  security-scan:
    name: Run Comprehensive Security Scan
    runs-on: ubuntu-latest
    
    steps:
      # ========================================================================
      # STEP 1: Checkout Code
      # ========================================================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================================================
      # STEP 2: Set up Python
      # ========================================================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # ========================================================================
      # STEP 3: Install Dependencies
      # ========================================================================
      - name: Install dependencies
        run: |
          pip install python-owasp-zap-v2.4 requests python-dotenv colorama

      # ========================================================================
      # STEP 4: Start ZAP Container
      # ========================================================================
      - name: Start ZAP
        run: |
          docker run -d \
            -p 8080:8080 \
            -v $(pwd):/zap/wrk/:rw \
            --name zap \
            zaproxy/zap-bare \
            zap.sh -daemon \
            -host 0.0.0.0 \
            -port 8080 \
            -config api.disablekey=true \
            -config 'api.addrs.addr.name=.*' \
            -config api.addrs.addr.regex=true

      # ========================================================================
      # STEP 5: Wait for ZAP to be Ready
      # ========================================================================
      - name: Wait for ZAP
        run: |
          echo "Waiting for ZAP to start..."
          timeout 120 bash -c 'until curl -f http://localhost:8080/JSON/core/view/version/; do sleep 2; done'
          echo "ZAP is ready!"

      # ========================================================================
      # STEP 6: Run Security Scan (Full)
      # ========================================================================
      - name: Run security scan
        env:
          ZAP_TARGET_URL: ${{ inputs.target_url || secrets.ZAP_TARGET_URL || 'http://testphp.vulnweb.com' }}
          ZAP_SCAN_TYPE: ${{ inputs.scan_type || 'full' }}
          ZAP_MAX_HIGH: 0
          ZAP_MAX_MEDIUM: 0
          ZAP_MAX_LOW: 10
          ZAP_HOST: localhost
          ZAP_PORT: 8080
          ZAP_REPORT_DIR: ./reports
        run: |
          echo "=========================================="
          echo "Nightly Security Scan"
          echo "=========================================="
          echo "Target: $ZAP_TARGET_URL"
          echo "Scan Type: $ZAP_SCAN_TYPE"
          echo "Started: $(date)"
          echo "=========================================="
          
          python step2_configurable_scan.py
          
          echo "=========================================="
          echo "Completed: $(date)"
          echo "=========================================="

      # ========================================================================
      # STEP 7: Upload Reports as Artifacts
      # ========================================================================
      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-nightly-reports-${{ github.run_number }}
          path: reports/
          retention-days: 365  # Keep nightly reports for 1 year

      # ========================================================================
      # STEP 8: Generate Compliance Report
      # ========================================================================
      - name: Generate compliance report
        if: always()
        run: |
          echo "Generating compliance report..."
          
          SUMMARY_FILE=$(ls -t reports/zap_summary_*.json | head -1)
          
          if [ -f "$SUMMARY_FILE" ]; then
            python3 << 'EOF'
          import json
          from datetime import datetime
          
          # Read summary
          with open('$SUMMARY_FILE') as f:
              data = json.load(f)
          
          # Generate compliance report
          report = f"""
          ==========================================
          SECURITY COMPLIANCE REPORT
          ==========================================
          
          Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
          Target: {data['target_url']}
          Scan Type: {data['scan_type']}
          
          ------------------------------------------
          SUMMARY
          ------------------------------------------
          Total Vulnerabilities: {data['total_alerts']}
          
          High Risk:        {data['risk_counts']['High']:3d} (Max: {data['thresholds']['max_high']})
          Medium Risk:      {data['risk_counts']['Medium']:3d} (Max: {data['thresholds']['max_medium']})
          Low Risk:         {data['risk_counts']['Low']:3d} (Max: {data['thresholds']['max_low']})
          Informational:    {data['risk_counts']['Informational']:3d}
          
          ------------------------------------------
          COMPLIANCE STATUS
          ------------------------------------------
          Overall: {'COMPLIANT' if data['passed'] else 'NON-COMPLIANT'}
          
          High Risk:   {'âœ“ PASS' if data['risk_counts']['High'] <= data['thresholds']['max_high'] else 'X FAIL'}
          Medium Risk: {'âœ“ PASS' if data['risk_counts']['Medium'] <= data['thresholds']['max_medium'] else 'X FAIL'}
          Low Risk:    {'âœ“ PASS' if data['risk_counts']['Low'] <= data['thresholds']['max_low'] else 'X FAIL'}
          """
          
          if data.get('high_risk_alerts'):
              report += "\n\n------------------------------------------\n"
              report += "HIGH RISK VULNERABILITIES\n"
              report += "------------------------------------------\n"
              for i, alert in enumerate(data['high_risk_alerts'], 1):
                  report += f"\n{i}. {alert['name']}\n"
                  report += f"   URL: {alert['url']}\n"
                  report += f"   Description: {alert['description'][:150]}...\n"
          
          report += "\n\n==========================================\n"
          report += "END OF REPORT\n"
          report += "==========================================\n"
          
          # Save to file
          with open('reports/compliance-report.txt', 'w') as f:
              f.write(report)
          
          print(report)
          EOF
          fi

      # ========================================================================
      # STEP 9: Create Job Summary
      # ========================================================================
      - name: Create job summary
        if: always()
        run: |
          SUMMARY_FILE=$(ls -t reports/zap_summary_*.json | head -1)
          
          if [ -f "$SUMMARY_FILE" ]; then
            python3 << 'EOF'
          import json
          import os
          from datetime import datetime
          
          with open(os.environ['SUMMARY_FILE']) as f:
              data = json.load(f)
          
          high = data['risk_counts']['High']
          medium = data['risk_counts']['Medium']
          low = data['risk_counts']['Low']
          total = data['total_alerts']
          passed = data['passed']
          
          # Create comprehensive summary
          summary = f"""# ðŸ”’ Nightly Security Scan Results
          
          **Date:** {datetime.now().strftime('%Y-%m-%d')}
          **Status:** {'âœ… COMPLIANT' if passed else 'âŒ NON-COMPLIANT'}
          **Target:** `{data['target_url']}`
          **Scan Type:** {data['scan_type']}
          
          ## Summary
          | Risk Level | Count | Threshold | Status |
          |------------|-------|-----------|--------|
          | ðŸ”´ High | {high} | {data['thresholds']['max_high']} | {'âœ… Pass' if high <= data['thresholds']['max_high'] else 'âŒ FAIL'} |
          | ðŸŸ  Medium | {medium} | {data['thresholds']['max_medium']} | {'âœ… Pass' if medium <= data['thresholds']['max_medium'] else 'âŒ FAIL'} |
          | ðŸŸ¡ Low | {low} | {data['thresholds']['max_low']} | {'âœ… Pass' if low <= data['thresholds']['max_low'] else 'âŒ FAIL'} |
          | â„¹ï¸ Info | {data['risk_counts']['Informational']} | - | - |
          | **Total** | **{total}** | - | - |
          
          ## Trend Analysis
          > Previous scans can be compared by downloading artifacts from past runs
          
          """
          
          if data.get('high_risk_alerts'):
              summary += "## âš ï¸ Critical Issues Requiring Immediate Attention\n\n"
              for i, alert in enumerate(data['high_risk_alerts'][:10], 1):
                  summary += f"### {i}. {alert['name']}\n"
                  summary += f"- **URL:** `{alert['url']}`\n"
                  summary += f"- **Description:** {alert['description'][:200]}...\n\n"
              
              if len(data['high_risk_alerts']) > 10:
                  summary += f"_...and {len(data['high_risk_alerts']) - 10} more high-risk issues_\n\n"
          else:
              summary += "## âœ… No High Risk Vulnerabilities Detected\n\n"
          
          summary += """
          ---
          
          ## Next Steps
          
          """
          
          if not passed:
              summary += """
          ### Action Required:
          1. Review high-risk vulnerabilities immediately
          2. Create JIRA tickets for remediation
          3. Schedule follow-up scan after fixes
          4. Update security documentation
          """
          else:
              summary += """
          ### Recommendations:
          1. Continue monitoring for new vulnerabilities
          2. Review low-risk findings for potential improvements
          3. Update security baseline documentation
          """
          
          summary += "\n\nðŸ“Š **Full reports and compliance documentation available in artifacts**\n"
          
          # Write to GitHub Step Summary
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'w') as f:
              f.write(summary)
          EOF
          fi
        env:
          SUMMARY_FILE: ${{ env.SUMMARY_FILE }}

      # ========================================================================
      # STEP 10: Create Issue on Failure
      # ========================================================================
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Find latest summary file
            const summaryFiles = fs.readdirSync('reports')
              .filter(f => f.startsWith('zap_summary_'))
              .sort()
              .reverse();
            
            if (summaryFiles.length === 0) {
              console.log('No summary file found');
              return;
            }
            
            const summaryPath = `reports/${summaryFiles[0]}`;
            const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
            
            const high = summary.risk_counts.High;
            const medium = summary.risk_counts.Medium;
            const low = summary.risk_counts.Low;
            
            // Create issue body
            let body = `# ðŸš¨ Nightly Security Scan Failed\n\n`;
            body += `**Date:** ${new Date().toISOString().split('T')[0]}\n`;
            body += `**Target:** \`${summary.target_url}\`\n`;
            body += `**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n`;
            
            body += `## Summary\n`;
            body += `- ðŸ”´ High: ${high}\n`;
            body += `- ðŸŸ  Medium: ${medium}\n`;
            body += `- ðŸŸ¡ Low: ${low}\n\n`;
            
            if (summary.high_risk_alerts && summary.high_risk_alerts.length > 0) {
              body += `## High Risk Vulnerabilities\n\n`;
              summary.high_risk_alerts.slice(0, 5).forEach((alert, i) => {
                body += `${i + 1}. **${alert.name}**\n`;
                body += `   - URL: \`${alert.url}\`\n`;
                body += `   - ${alert.description.substring(0, 150)}...\n\n`;
              });
            }
            
            body += `\n## Action Items\n`;
            body += `- [ ] Review vulnerabilities\n`;
            body += `- [ ] Create remediation tickets\n`;
            body += `- [ ] Update security documentation\n`;
            body += `- [ ] Schedule follow-up scan\n`;
            
            // Create issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Scan Failed - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['security', 'vulnerability', 'nightly-scan']
            });

      # ========================================================================
      # STEP 11: Clean Up
      # ========================================================================
      - name: Stop ZAP
        if: always()
        run: |
          docker stop zap || true
          docker rm zap || true